apiVersion: operator.victoriametrics.com/v1beta1
kind: VMRule
metadata:
  labels:
    role: alert-rules
  name: node-rules
  namespace: vm-operator
spec:
  groups:
    - name: NodeExporter
      interval: 60s
      rules:
        - alert: NodeCPUHighUsage
          annotations:
            description: |
              CPU usage at {{ $labels.instance }} has been above 90% for the last 15 minutes, is currently at {{ printf "%.2f" $value }}%.
            summary: High CPU usage.
          expr: |
            sum without(mode) (avg without (cpu) (rate(node_cpu_seconds_total{job="vm-operator/nodes-metrics", mode!="idle"}[2m]))) * 100 > 85
          for: 15m
          labels:
            severity: warning
        - alert: NodeMemoryMajorPagesFaults
          annotations:
            description: |
              Memory major pages are occurring at very high rate at {{ $labels.instance }}, 500 major page faults per second for the last 15 minutes, is currently at {{ printf "%.2f" $value }}.
              Please check that there is enough memory available at this instance.
            summary: Memory major page faults are occurring at very high rate.
          expr: |
            rate(node_vmstat_pgmajfault{job="vm-operator/nodes-metrics"}[5m]) > 500
          for: 15m
          labels:
            severity: warning
        - alert: NodeMemoryHighUtilization
          annotations:
            description: |
              Memory is filling up at {{ $labels.instance }}, has been above 90% for the last 15 minutes, is currently at {{ printf "%.2f" $value }}%.
            summary: Host is running out of memory.
          expr: |
            100 - (node_memory_MemAvailable_bytes{job="vm-operator/nodes-metrics"} / node_memory_MemTotal_bytes{job="vm-operator/nodes-metrics"} * 100) > 90
          for: 15m
          labels:
            severity: warning
        - alert: NodeDiskIOSaturation
          annotations:
            description: |
              Disk IO queue (aqu-sq) is high on {{ $labels.device }} at {{ $labels.instance }}, has been above 10 for the last 15 minutes, is currently at {{ printf "%.2f" $value }}.
              This symptom might indicate disk saturation.
            summary: Disk IO queue is high.
          expr: |
            rate(node_disk_io_time_weighted_seconds_total{job="vm-operator/nodes-metrics", device!=""}[5m]) > 10
          for: 30m
          labels:
            severity: warning
        - alert: NodeFileDescriptorLimit
          annotations:
            description: File descriptors limit at {{ $labels.instance }} is currently at {{
              printf "%.2f" $value }}%.
            summary: Kernel is predicted to exhaust file descriptors limit soon.
          expr: |
            (
              node_filefd_allocated{job="vm-operator/nodes-metrics"} * 100 / node_filefd_maximum{job="vm-operator/nodes-metrics"} > 70
            )
          for: 15m
          labels:
            severity: warning
        - alert: NodeFileDescriptorLimit
          annotations:
            description: File descriptors limit at {{ $labels.instance }} is currently at {{
              printf "%.2f" $value }}%.
            summary: Kernel is predicted to exhaust file descriptors limit soon.
          expr: |
            (
              node_filefd_allocated{job="vm-operator/nodes-metrics"} * 100 / node_filefd_maximum{job="vm-operator/nodes-metrics"} > 90
            )
          for: 15m
          labels:
            severity: critical
        - alert: NodeNetworkTransmitErrs
          annotations:
            description: '{{ $labels.instance }} interface {{ $labels.device }} has encountered
              {{ printf "%.0f" $value }} transmit errors in the last two minutes.'
            summary: Network interface is reporting many transmit errors.
          expr: |
            rate(node_network_transmit_errs_total{job="vm-operator/nodes-metrics"}[2m]) / rate(node_network_transmit_packets_total{job="vm-operator/nodes-metrics"}[2m]) > 0.01
          for: 1h
          labels:
            severity: warning
        - alert: NodeNetworkReceiveErrs
          annotations:
            description: '{{ $labels.instance }} interface {{ $labels.device }} has encountered
              {{ printf "%.0f" $value }} receive errors in the last two minutes.'
            summary: Network interface is reporting many receive errors.
          expr: |
            rate(node_network_receive_errs_total{job="vm-operator/nodes-metrics"}[2m]) / rate(node_network_receive_packets_total{job="vm-operator/nodes-metrics"}[2m]) > 0.01
          for: 1h
          labels:
            severity: warning
        - alert: NodeTextFileCollectorScrapeError
          annotations:
            description: Node Exporter text file collector on {{ $labels.instance }} failed
              to scrape.
            summary: Node Exporter text file collector failed to scrape.
          expr: |
            node_textfile_scrape_error{job="vm-operator/nodes-metrics"} == 1
          labels:
            severity: warning
        - alert: NodeFilesystemAlmostOutOfSpace
          annotations:
            description: Filesystem on {{ $labels.device }}, mounted on {{ $labels.mountpoint
              }}, at {{ $labels.instance }} has only {{ printf "%.2f" $value }}% available space
              left.
            summary: Filesystem has less than 3% space left.
          expr: |
            (
              node_filesystem_avail_bytes{job="vm-operator/nodes-metrics",fstype!="",mountpoint!=""} / node_filesystem_size_bytes{job="vm-operator/nodes-metrics",fstype!="",mountpoint!=""} * 100 < 3
            and
              node_filesystem_readonly{job="vm-operator/nodes-metrics",fstype!="",mountpoint!=""} == 0
            )
          for: 30m
          labels:
            severity: critical
        - alert: NodeFilesystemAlmostOutOfSpace
          annotations:
            description: Filesystem on {{ $labels.device }}, mounted on {{ $labels.mountpoint
              }}, at {{ $labels.instance }} has only {{ printf "%.2f" $value }}% available space
              left.
            summary: Filesystem has less than 5% space left.
          expr: |
            (
              node_filesystem_avail_bytes{job="vm-operator/nodes-metrics",fstype!="",mountpoint!=""} / node_filesystem_size_bytes{job="vm-operator/nodes-metrics",fstype!="",mountpoint!=""} * 100 < 5
            and
              node_filesystem_readonly{job="vm-operator/nodes-metrics",fstype!="",mountpoint!=""} == 0
            )
          for: 30m
          labels:
            severity: warning